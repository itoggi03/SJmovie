{% extends 'base.html' %}
{% block content %}
<!-- 
<div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
  <div class="carousel-inner">
  <div class="carousel-item active">
    <img src="{{ first.poster_path }}" class="d-block" alt="">
  </div>
    {% for movie in movies %}
      <div class="carousel-item">
        <img src="{{ movie.poster_path }}" class="d-block" alt="">
      </div>
    {% endfor %}  
  <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>-->
<div class="container">

<div class="row">
		<div class="col-md-12 bg-dark">
      <div class="d-flex justify-content-between">
        <div class="pt-3">Top Rated</div>
        <a href="{% url 'movies:topratedlist' %}">
          <i class="far fa-plus-square"></i>
        </a>
      </div>
      <div id="Carousel" class="carousel slide">
        <ol class="carousel-indicators">
            <li data-target="#Carousel" data-slide-to="0" class="active"></li>
            <li data-target="#Carousel" data-slide-to="1"></li>
            <li data-target="#Carousel" data-slide-to="2"></li>
        </ol>
        <!-- Carousel items -->
        <div class="carousel-inner">

        <div class="carousel-item active">
          <div class="row mt-3">
          {% for f in first %}
            <div class="col-md-4">
              <a href="{% url 'movies:detail' f.pk %}"><img src="{{f.poster_path}}" alt="Image" style="max-width:100%; height: 480px;"></a>
              <form action="{%url 'movies:like' f.pk%}" data-articleId= "{{f.pk}}" id = "form_like" method="POST" class="d-inline">
                {% csrf_token %}
                {% if user in f.like_users.all %}
                  <button class="btn btn-link">
                    <i class="fas fa-heart fa-lg heart-{{f.pk}}" style="color:crimson;"></i>
                  </button>
                {% else %}
                  <button class="btn btn-link ">
                    <i class="fas fa-heart fa-lg heart-{{f.pk}}" style="color:black;"></i>
                  </button>
                {% endif %}
              </form>
              <span id ="like_count-{{f.pk}}">{{ f.like_users.all|length }} </span>
            </div>
          {% endfor %}
          </div><!--.row-->
        </div><!--.item-->
          
        <div class="carousel-item">
          <div class="row mt-3">
            {% for s in second %}
            <div class="col-md-4">
              <a href="{% url 'movies:detail' s.pk %}"><img src="{{s.poster_path}}" alt="Image" style="max-width:100%; height: 480px;"></a>
              <form action="{%url 'movies:like' s.pk%}" data-articleId= "{{s.pk}}" id = "form_like" method="POST" class="d-inline">
                {% csrf_token %}
                {% if user in s.like_users.all %}
                  <button class="btn btn-link">
                    <i class="fas fa-heart fa-lg heart-{{s.pk}}" style="color:crimson;"></i>
                  </button>
                {% else %}
                  <button class="btn btn-link ">
                    <i class="fas fa-heart fa-lg heart-{{s.pk}}" style="color:black;"></i>
                  </button>
                {% endif %}
              </form>
              <span id ="like_count-{{s.pk}}">{{ s.like_users.all|length }} </span>
            </div>
          {% endfor %}
          </div><!--.row-->
        </div><!--.item-->
          
        <div class="carousel-item">
          <div class="row mt-3">
            {% for t in third %}
              <div class="col-md-4"><a href="{% url 'movies:detail' t.pk %}"><img src="{{t.poster_path}}" alt="Image" style="max-width:100%;height: 480px;"></a>
              <form action="{%url 'movies:like' t.pk%}" data-articleId= "{{t.pk}}" id = "form_like" method="POST" class="d-inline">
                {% csrf_token %}
                {% if user in t.like_users.all %}
                  <button class="btn btn-link">
                    <i class="fas fa-heart fa-lg heart-{{t.pk}}" style="color:crimson;"></i>
                  </button>
                {% else %}
                  <button class="btn btn-link ">
                    <i class="fas fa-heart fa-lg heart-{{t.pk}}" style="color:black;"></i>
                  </button>
                {% endif %}
              </form>
              <span id ="like_count-{{t.pk}}">{{ t.like_users.all|length }} </span>
            
            </div>
          {% endfor %}
          </div><!--.row-->
        </div><!--.item-->
          
        </div><!--.carousel-inner-->
          <a data-slide="prev" href="#Carousel" class="left carousel-control">‹</a>
          <a data-slide="next" href="#Carousel" class="right carousel-control">›</a>
        </div><!--.Carousel-->
                 
		</div>
	</div>
  </div>
  <br>
  <hr>
  {% if request.user.is_authenticated %}
    <div class="recommand_movies">
      {% if recommand %}
      <h2>{{request.user}}님에게 추천하는 영화</h2>
      {% for movie in recommand %}
        <a href="{% url 'movies:detail' movie.pk %}"><img src="{{movie.poster_path}}" alt="Image" style="max-width:100%; height: 480px;"></a>
      {% endfor %}
      {% else %}
        <div>영화에 좋아요를 눌러주시면 영화를 추천해드립니다</div>
      {% endif %}
    </div>
  {% endif %}
{% endblock content %}

{% block script %}
  <script>
    const likeBtnForm = document.querySelectorAll('#form_like')
    likeBtnForm.forEach(likeBtnForm=>{
      // console.log(likeBtnForm.dataset.articleid) // movie의 pk 
      const movieId = likeBtnForm.dataset.articleid 
      likeBtnForm.addEventListener('click', function (e) {
        e.preventDefault()
        
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value
        const options = { headers: {'X-CSRFToken': csrfToken}}

        const API_URL = `/movies/${movieId}/like/`
        axios.post(API_URL, {}, options)
          .then(res=>{
            // console.log(res)
            const {is_like,like_count} = res.data

            // 하트 가져오기
            const likeHeart = document.querySelector(`.heart-${movieId}`)
            likeHeart.style.color = is_like ? 'crimson' : 'black'
            const likeCount = document.querySelector(`#like_count-${movieId}`)
            likeCount.innerText = like_count
          })
          .catch(err=>{
            console.error(err)
          })
      })
    }) 
  </script>
{% endblock  %}